## 原理

格式化字符串函数可以接受**可变数量的参数**，并将**第一个参数作为格式化字符串，根据其来解析之后的参数**。

通俗来说，**格式化字符串函数就是将计算机内存中表示的数据转化为我们人类可读的字符串格式**。

几乎所有的 C/C++ 程序都会利用格式化字符串函数来**输出信息**，**调试程序**，或者**处理字符串**。

一般来说，格式化字符串在利用的时候主要分为三个部分：**格式化字符串函数 、格式化字符串 、后续参数(可选)**

格式化字符串形式如下:
```asm
%[parameter][flags][field width][.precision][length]type
```
其中
- parameter
    - n$，获取格式化字符串中的指定参数
- flag
- field width
    - 输出的最小宽度
- precision
    - 输出的最大长度
- length，输出的长度
    - hh，输出一个字节
    - h，输出一个双字节
type为格式化符号，

常见的一些格式化符号及其含义如下：

| 格式   | 含义                                                                     |
| ---- | ---------------------------------------------------------------------- |
| %x   | 输出栈上的参数（4 或 8 字节）并以 hex 显示。例如 `%x %x %x` 就依次把栈值打印出来。这是最常用来“泄露栈上内容”的格式。 |
| %p   | 打印指针（和 `%x` 类似）                                                        |
| %s   | 把当前栈上的值当作 _指针_，输出这个地址指向的字符串（泄露内存、GOT表内容）                               |
| %n   | 把 **当前 printf 已写出的字节数** _写到对应参数指向的地址_。这是 **最强武器**。                     |
| %hn  | 写2字节                                                                   |
| %hhn | 写1字节（最常用）                                                              |
一般掌握好“%n”和“%p”的利用就差不多了
例如：
```c
int x;
printf("AAAA%n", &x);

```
此时x=4
可以通过
```C
AAAA%123c%4$n
```
让 printf 多输出 123 个字符，然后 `%4$n` 将 “已经输出的字节数” 写入第 4 个参数指向的地址。
`%4$n`拆分：`%`格式化字符标识，`4$`使用第4个字符作为`%n`的写入地址
另：
```C
printf("%s %d %s %x %x %x %3$s", "Hello World!", 233, "\n");
```
`%3$s`使用第 3 个参数格式化进行输出。

可以用它：

- 改 GOT；
- 堆上/栈上写任意值；
- 分段写入 4 字节、2 字节、1 字节；



## 常见利用总结

#### 栈偏移泄露地址

输入:
```C
AAAA.%p.%p.%p.%p.%p....
```
前面为paddings 后面%p泄露对应地址

在CTF中，我们通常通过输入这样的格式化字符串计算**格式化字符串在栈上的位置相对于 printf 参数列表的偏移**
这个偏移用于定位我们输入的缓冲区在栈上的位置，从而可以用 `%n` 等写内存，或者泄露栈上的其他数据（比如返回地址、libc 地址等）。
例如：
如果 `AAAA` 出现在第 6 个 `%p`，那么：
- 在利用时，要用 `%6$p` 来直接读这个位置。
- 用 `%6$n` 来向这个地址写入已输出的字符数。

## pwntools编写

```python
fmtstr_payload(offset, {printf_got: system_addr})(偏移，{原地址：目的地址})

fmtstr_payload(offset, writes, numbwritten=0, write_size=‘byte’)

```
第一个参数表示格式化字符串的偏移；
第二个参数表示需要利用%n写入的数据，采用字典形式，我们要将printf的GOT数据改为system函数地址，就写成{printfGOT:
systemAddress}；本题是将0804a048处改为0x2223322
第三个参数表示已经输出的字符个数，这里没有，为0，采用默认值即可；
第四个参数表示写入方式，是按字节（byte）、按双字节（short）还是按四字节（int），对应着hhn、hn和n，默认值是byte，即按hhn写。
fmtstr_payload函数返回的就是payload